package us.spotco.malwarescanner;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;

import java.io.File;

import gnu.trove.set.hash.THashSet;

public class EventReceiver extends BroadcastReceiver {

    @Override
    public final void onReceive(Context context, Intent intent) {
        if (intent.getAction().equals(Intent.ACTION_BOOT_COMPLETED)) {
            Utils.considerStartService(context);
        }
        if (intent.getAction().equals(Intent.ACTION_PACKAGE_REPLACED)) {
            if (intent.getDataString().contains(context.getPackageName())) {
                Utils.considerStartService(context); //We've been updated, restart service
            } else {
                //scanApp(context, intent.getDataString());//An app was updated, scan it
            }
        }
        if (intent.getAction().equals(Intent.ACTION_PACKAGE_ADDED)) {
            //scanApp(context, intent.getDataString());//An app was installed, scan it
        }
    }

    private static void scanApp(Context context, String appID) {
        if (Utils.isServiceRunning(MalwareScannerService.class, context)) {
            THashSet<File> filesToScan = new THashSet<>();
            try {
                filesToScan.add(new File(context.getPackageManager().getApplicationInfo(appID, PackageManager.GET_META_DATA).sourceDir));
            } catch (Exception e) {
                e.printStackTrace();
            }
            if (filesToScan.size() > 0) {
                new MalwareScanner(null, context, false).executeOnExecutor(Utils.getThreadPoolExecutor(), filesToScan);
            }
        }
    }

}
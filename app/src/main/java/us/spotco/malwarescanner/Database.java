/*
Hypatia: A realtime malware scanner for Android
Copyright (c) 2017-2018 Divested Computing Group

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/
package us.spotco.malwarescanner;

import android.content.Context;
import android.content.SharedPreferences;
import android.os.AsyncTask;
import android.widget.TextView;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.InetSocketAddress;
import java.net.Proxy;
import java.net.URL;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.zip.GZIPInputStream;

class Database {

    private static TextView log = null;
    private static SharedPreferences prefs = null;
    private static File databasePath = null;
    private static ThreadPoolExecutor threadPoolExecutor = null;

    public final static HashSet<SignatureDatabase> signatureDatabases = new HashSet<>();
    public final static String baseURL = "https://divested.dev/MalwareScannerSignatures/";
    public final static String baseURLOnion = "https://hypatiagbf5vp3ba.onion/MalwareScannerSignatures/"; //TODO: Setup the .onion

    public final static HashMap<String, String> signaturesMD5 = new HashMap<>();
    public final static HashMap<String, String> signaturesSHA1 = new HashMap<>();
    public final static HashMap<String, String> signaturesSHA256 = new HashMap<>();

    private static final DateFormat dateFormat = new SimpleDateFormat(Utils.getContext().getString(R.string.simple_date_format_short));

    public Database(TextView log) {
        Database.log = log;
        threadPoolExecutor = (ThreadPoolExecutor) Executors.newScheduledThreadPool(Utils.getMaxThreads());
    }

    public static boolean areDatabasesAvailable() {
        return databasePath != null && databasePath.listFiles().length > 0;
    }

    public static boolean isDatabaseLoaded() {
        return signaturesMD5.size() > 0 && signaturesSHA1.size() > 0 && signaturesSHA256.size() > 0;
    }

    public static int getSignatureCount() {
        return signaturesMD5.size() + signaturesSHA1.size() + signaturesSHA256.size();
    }

    public static void updateDatabase(Context context, HashSet<SignatureDatabase> signatureDatabases) {
        initDatabase(context);
        log.append(context.getString(R.string.main_database_updating, signatureDatabases.size() + "")+ "\n");
        for (SignatureDatabase signatureDatabase : signatureDatabases) {
            boolean onionRouting = prefs.getBoolean("ONION_ROUTING", false);
            new Downloader().executeOnExecutor(threadPoolExecutor, onionRouting, signatureDatabase.getUrl(), databasePath + "/" + signatureDatabase.getName());
        }
    }

    private static void initDatabase(Context context) {
        databasePath = new File(context.getFilesDir() + "/signatures/");
        databasePath.mkdir();

        signatureDatabases.clear();

        prefs = context.getSharedPreferences(BuildConfig.APPLICATION_ID, Context.MODE_PRIVATE);
        if (prefs.getBoolean("SIGNATURES_EXTRA", false)) {
            //no databases
        }
        if (prefs.getBoolean("SIGNATURES_ESET", true)) {
            signatureDatabases.add(new SignatureDatabase(baseURL + "eset.hdb.gz"));
            signatureDatabases.add(new SignatureDatabase(baseURL + "eset.hsb.gz"));
        }
        if (prefs.getBoolean("SIGNATURES_CLAMAV-MAIN", false)) {
            signatureDatabases.add(new SignatureDatabase(baseURL + "main.hdb.gz"));
            signatureDatabases.add(new SignatureDatabase(baseURL + "main.hsb.gz"));
        }
        if (prefs.getBoolean("SIGNATURES_CLAMAV-DAILY", false)) {
            signatureDatabases.add(new SignatureDatabase(baseURL + "daily.hdb.gz"));
            signatureDatabases.add(new SignatureDatabase(baseURL + "daily.hsb.gz"));
        }
        if (prefs.getBoolean("SIGNATURES_CLAMAV-ANDROID", true)) {
            signatureDatabases.add(new SignatureDatabase(baseURL + "Android.hdb.gz"));
            signatureDatabases.add(new SignatureDatabase(baseURL + "Android.hsb.gz"));
        }
    }

    public static void loadDatabase(Context context, boolean ignoreifLoaded, HashSet<SignatureDatabase> signatureDatabases) {
        if (!isDatabaseLoaded() || !ignoreifLoaded && isDatabaseLoaded()) {
            initDatabase(context);
            signaturesMD5.clear();
            signaturesSHA1.clear();
            signaturesSHA256.clear();
            System.gc();
            for (SignatureDatabase database : signatureDatabases) {
                File databaseLocation = new File(databasePath + "/" + database.getName());
                if (databaseLocation.exists()) {
                    try {
                        BufferedReader reader;
                        if (databaseLocation.getName().endsWith(".gz")) {
                            reader = new BufferedReader(new InputStreamReader(new GZIPInputStream(new FileInputStream(databaseLocation))));
                        } else {
                            reader = new BufferedReader(new FileReader(databaseLocation));
                        }
                        String line;
                        if (database.getName().contains(".hdb")) {//.hdb format: md5, size, name
                            while ((line = reader.readLine()) != null) {
                                String[] lineS = line.split(":");
                                if (Utils.TRIM_VARIANT_NUMBER) {
                                    lineS[2] = lineS[2].split("-")[0];
                                }
                                signaturesMD5.put(lineS[0].substring(0, Utils.MAX_HASH_LENGTH), lineS[2]);
                            }
                        } else if (database.getName().contains(".hsb")) {//.hsb format: sha256, size, name
                            while ((line = reader.readLine()) != null) {
                                String[] lineS = line.split(":");
                                if (Utils.TRIM_VARIANT_NUMBER) {
                                    lineS[2] = lineS[2].split("-")[0];
                                }
                                if (lineS[0].length() == 32) {
                                    signaturesSHA1.put(lineS[0].substring(0, Utils.MAX_HASH_LENGTH), lineS[2]);
                                } else {
                                    signaturesSHA256.put(lineS[0].substring(0, Utils.MAX_HASH_LENGTH), lineS[2]);
                                }
                            }
                        }
                        reader.close();
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }
            signaturesMD5.put("44d88612fea8a8f36de82e1278abb02f".substring(0, Utils.MAX_HASH_LENGTH), "Eicar-Test-Signature");
            System.gc();
        }
    }

    public static class Downloader extends AsyncTask<Object, String, String> {
        @Override
        protected String doInBackground(Object... objects) {
            boolean onionRouting = (boolean) objects[0];
            String url = (String) objects[1];
            File out = new File((String) objects[2]);
            try {
                HttpURLConnection connection;
                if (onionRouting) {
                    Utils.waitUntilOrbotIsAvailable();
                    //url = url.replaceAll(baseURL, baseURLOnion); //TODO: Setup the .onion
                    Proxy orbot = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress("127.0.0.1", 9050));
                    connection = (HttpURLConnection) new URL(url).openConnection(orbot);
                } else {
                    connection = (HttpURLConnection) new URL(url).openConnection();
                }
                connection.setConnectTimeout(90000);
                connection.setReadTimeout(30000);
                connection.addRequestProperty("User-Agent", "Hypatia");
                String lastModifiedLocal = "";
                if (out.exists()) {
                    connection.setIfModifiedSince(out.lastModified());
                    lastModifiedLocal = Utils.getContext().getString(R.string.main_database_not_modified_since, dateFormat.format(new Date(out.lastModified())));
                }
                connection.connect();
                String lastModifiedServer = dateFormat.format(new Date(connection.getLastModified()));
                int res = connection.getResponseCode();
                if (res != 304) {
                    if (res == 200) {
                        if (out.exists()) {
                            out.delete();
                        }
                        FileOutputStream fileOutputStream = new FileOutputStream(out);

                        final byte data[] = new byte[1024];
                        int count;
                        while ((count = connection.getInputStream().read(data, 0, 1024)) != -1) {
                            fileOutputStream.write(data, 0, count);
                        }

                        fileOutputStream.close();
                        publishProgress(url.replaceAll(baseURL, "")
                                + "\n\t" + Utils.getContext().getString(R.string.main_database_download_success)
                                + "\n\t" + Utils.getContext().getString(R.string.main_database_released_on, lastModifiedServer) + "\n");
                    } else {
                        publishProgress(url.replaceAll(baseURL, "")
                                + "\n\t" + Utils.getContext().getString(R.string.main_database_download_error, res + "") + "\n");
                    }
                } else {
                    publishProgress(url.replaceAll(baseURL, "")
                            + "\n\t" + Utils.getContext().getString(R.string.main_database_not_changed) + lastModifiedLocal + "\n");
                }
                connection.disconnect();
            } catch (Exception e) {
                e.printStackTrace();
                out.delete();
                publishProgress(url.replaceAll(baseURL, "")
                        + "\n" + Utils.getContext().getString(R.string.main_database_download_error_logcat) + "\n");
            }
            return null;
        }

        @Override
        protected final void onProgressUpdate(String... progress) {
            log.append(progress[0] + "\n");
        }
    }
}
